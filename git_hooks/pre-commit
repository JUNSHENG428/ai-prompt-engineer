#!/usr/bin/env python3
"""
Gité¢„æäº¤é’©å­
é˜²æ­¢æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚APIå¯†é’¥ï¼‰è¢«æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ
"""

import os
import re
import sys
import subprocess
from typing import List, Tuple, Optional

# APIå¯†é’¥å’Œæ•æ„Ÿä¿¡æ¯çš„æ¨¡å¼
SECRET_PATTERNS = {
    "OpenAI API Key": r"sk-[A-Za-z0-9]{48,}",
    "DeepSeek API Key": r"sk-[A-Za-z0-9]{32,}",
    "Anthropic API Key": r"sk-ant-[A-Za-z0-9\-]{95,}",
    "Google API Key": r"AIza[A-Za-z0-9\-_]{35}",
    "AWS Access Key": r"AKIA[A-Z0-9]{16}",
    "GitHub Token": r"ghp_[A-Za-z0-9]{36}",
    "JWT Token": r"eyJ[A-Za-z0-9\-_]+\.[A-Za-z0-9\-_]+\.[A-Za-z0-9\-_]+",
    "Private Key": r"-----BEGIN [A-Z ]+PRIVATE KEY-----",
    "Password": r"(?i)(password|passwd|pwd)\s*[=:]\s*['\"]?[a-zA-Z0-9!@#$%^&*()_+\-=\[\]{}|;:,.<>?]{8,}['\"]?",
    "Database URL": r"(postgresql|mysql|mongodb)://[^:]+:[^@]+@[^/]+",
}

# æ’é™¤æ¨¡å¼ï¼ˆç¤ºä¾‹å’Œæ–‡æ¡£ï¼‰
EXCLUDE_PATTERNS = [
    r"example",
    r"sample", 
    r"demo",
    r"test",
    r"placeholder",
    r"your_api_key",
    r"your_key_here",
    r"replace_with",
    r"xxx",
    r"\*{3,}",
    r"\.{3,}",
    r"x{8,}",
]

# éœ€è¦æ£€æŸ¥çš„æ–‡ä»¶æ‰©å±•å
CHECKED_EXTENSIONS = [
    ".py", ".js", ".jsx", ".ts", ".tsx", ".java", ".cpp", ".c", ".h",
    ".php", ".rb", ".go", ".rs", ".swift", ".kt", ".scala", ".sh",
    ".json", ".yaml", ".yml", ".xml", ".ini", ".cfg", ".conf",
    ".txt", ".md", ".rst", ".env", ".config"
]

# æ’é™¤çš„æ–‡ä»¶å’Œç›®å½•
EXCLUDED_PATHS = [
    ".git/",
    "__pycache__/",
    "node_modules/",
    ".pyc",
    ".so",
    ".dll",
    ".exe",
    ".bin",
    ".class",
    ".jar",
    ".war"
]

class Colors:
    """ç»ˆç«¯é¢œè‰²å¸¸é‡"""
    RED = '\033[91m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    BLUE = '\033[94m'
    MAGENTA = '\033[95m'
    CYAN = '\033[96m'
    WHITE = '\033[97m'
    BOLD = '\033[1m'
    END = '\033[0m'

def get_staged_files() -> List[str]:
    """è·å–æš‚å­˜åŒºçš„æ–‡ä»¶åˆ—è¡¨"""
    try:
        result = subprocess.run(
            ["git", "diff", "--cached", "--name-only"],
            capture_output=True,
            text=True,
            check=True
        )
        return [f.strip() for f in result.stdout.split('\n') if f.strip()]
    except subprocess.CalledProcessError:
        return []

def should_check_file(file_path: str) -> bool:
    """åˆ¤æ–­æ˜¯å¦åº”è¯¥æ£€æŸ¥è¯¥æ–‡ä»¶"""
    # æ£€æŸ¥æ˜¯å¦è¢«æ’é™¤
    for excluded in EXCLUDED_PATHS:
        if excluded in file_path:
            return False
    
    # æ£€æŸ¥æ–‡ä»¶æ‰©å±•å
    _, ext = os.path.splitext(file_path)
    return ext.lower() in CHECKED_EXTENSIONS

def is_likely_example(line: str, match_text: str) -> bool:
    """åˆ¤æ–­æ˜¯å¦å¯èƒ½æ˜¯ç¤ºä¾‹ä»£ç """
    line_lower = line.lower()
    
    # æ£€æŸ¥æ³¨é‡Š
    if any(comment in line for comment in ['#', '//', '/*', '*', '<!--']):
        return True
    
    # æ£€æŸ¥ç¤ºä¾‹æ ‡è¯†
    if any(pattern in line_lower for pattern in EXCLUDE_PATTERNS):
        return True
    
    # æ£€æŸ¥åŒ¹é…çš„æ–‡æœ¬æ˜¯å¦åŒ…å«å ä½ç¬¦æ¨¡å¼
    for pattern in EXCLUDE_PATTERNS:
        if re.search(pattern, match_text, re.IGNORECASE):
            return True
    
    return False

def scan_file_content(file_path: str) -> List[Tuple[int, str, str, str]]:
    """
    æ‰«ææ–‡ä»¶å†…å®¹ï¼Œå¯»æ‰¾æ•æ„Ÿä¿¡æ¯
    
    Returns:
        List of (line_number, pattern_name, match_text, line_content)
    """
    if not os.path.exists(file_path):
        return []
    
    issues = []
    
    try:
        with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
            lines = f.readlines()
        
        for line_num, line in enumerate(lines, 1):
            for pattern_name, pattern in SECRET_PATTERNS.items():
                matches = re.finditer(pattern, line)
                
                for match in matches:
                    match_text = match.group()
                    
                    # è·³è¿‡å¯èƒ½çš„ç¤ºä¾‹
                    if is_likely_example(line, match_text):
                        continue
                    
                    issues.append((line_num, pattern_name, match_text, line.strip()))
    
    except (OSError, UnicodeDecodeError):
        pass
    
    return issues

def mask_secret(secret: str) -> str:
    """é®è”½æ•æ„Ÿä¿¡æ¯æ˜¾ç¤º"""
    if len(secret) <= 8:
        return "*" * len(secret)
    return secret[:4] + "*" * (len(secret) - 8) + secret[-4:]

def print_issue(file_path: str, line_num: int, pattern_name: str, match_text: str, line_content: str):
    """æ‰“å°å®‰å…¨é—®é¢˜"""
    print(f"{Colors.RED}âŒ å‘ç°æ•æ„Ÿä¿¡æ¯: {pattern_name}{Colors.END}")
    print(f"   {Colors.CYAN}æ–‡ä»¶:{Colors.END} {file_path}")
    print(f"   {Colors.CYAN}è¡Œå·:{Colors.END} {line_num}")
    print(f"   {Colors.CYAN}å†…å®¹:{Colors.END} {mask_secret(match_text)}")
    print(f"   {Colors.YELLOW}ä¸Šä¸‹æ–‡:{Colors.END} {line_content}")
    print()

def main():
    """ä¸»å‡½æ•°"""
    print(f"{Colors.BLUE}ğŸ” æ­£åœ¨æ£€æŸ¥æš‚å­˜æ–‡ä»¶ä¸­çš„æ•æ„Ÿä¿¡æ¯...{Colors.END}")
    
    # è·å–æš‚å­˜æ–‡ä»¶
    staged_files = get_staged_files()
    
    if not staged_files:
        print(f"{Colors.GREEN}âœ… æ²¡æœ‰æš‚å­˜æ–‡ä»¶éœ€è¦æ£€æŸ¥{Colors.END}")
        return 0
    
    total_issues = 0
    checked_files = 0
    
    for file_path in staged_files:
        if not should_check_file(file_path):
            continue
        
        checked_files += 1
        issues = scan_file_content(file_path)
        
        if issues:
            print(f"{Colors.YELLOW}âš ï¸ åœ¨æ–‡ä»¶ {file_path} ä¸­å‘ç°é—®é¢˜:{Colors.END}")
            for line_num, pattern_name, match_text, line_content in issues:
                print_issue(file_path, line_num, pattern_name, match_text, line_content)
                total_issues += 1
    
    print(f"{Colors.CYAN}ğŸ“Š æ£€æŸ¥ç»Ÿè®¡:{Colors.END}")
    print(f"   æ£€æŸ¥æ–‡ä»¶æ•°: {checked_files}")
    print(f"   å‘ç°é—®é¢˜æ•°: {total_issues}")
    
    if total_issues > 0:
        print(f"\n{Colors.RED}ğŸš« æäº¤è¢«é˜»æ­¢ï¼{Colors.END}")
        print(f"{Colors.YELLOW}è¯·å¤„ç†ä¸Šè¿°æ•æ„Ÿä¿¡æ¯åå†æ¬¡æäº¤ã€‚{Colors.END}")
        print(f"\n{Colors.WHITE}å»ºè®®çš„è§£å†³æ–¹æ¡ˆ:{Colors.END}")
        print(f"1. å°†æ•æ„Ÿä¿¡æ¯ç§»è‡³ç¯å¢ƒå˜é‡")
        print(f"2. ä½¿ç”¨é…ç½®æ–‡ä»¶ï¼ˆç¡®ä¿åœ¨.gitignoreä¸­ï¼‰")
        print(f"3. ä½¿ç”¨å®‰å…¨çš„å¯†é’¥ç®¡ç†æœåŠ¡")
        print(f"4. å¦‚æœæ˜¯ç¤ºä¾‹ä»£ç ï¼Œè¯·æ·»åŠ æ˜ç¡®çš„ç¤ºä¾‹æ ‡è¯†")
        print(f"\n{Colors.CYAN}è·³è¿‡æ£€æŸ¥ï¼ˆä¸æ¨èï¼‰:{Colors.END}")
        print(f"git commit --no-verify")
        return 1
    else:
        print(f"{Colors.GREEN}âœ… å®‰å…¨æ£€æŸ¥é€šè¿‡ï¼Œå…è®¸æäº¤{Colors.END}")
        return 0

if __name__ == "__main__":
    sys.exit(main()) 